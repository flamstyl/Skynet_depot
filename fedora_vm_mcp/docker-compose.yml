version: '3.8'

services:
  skynet-vm:
    build: .
    container_name: skynet-vm
    hostname: skynet-vm

    # KVM device for hardware acceleration
    devices:
      - /dev/kvm:/dev/kvm

    # Ports
    ports:
      - "5901:5901"  # VNC
      - "2222:2222"  # SSH (forwarded from guest)
      - "2200:22"    # Container SSH

    # Volumes
    volumes:
      - skynet-vm-data:/vm
      - ./shared:/shared  # Optional: shared folder between host and container

    # Environment variables
    environment:
      - VM_RAM=4096          # 4GB RAM
      - VM_CPUS=4            # 4 CPU cores
      - AUTO_START_VM=true   # Auto-start VM on container launch
      - VM_DISK=/vm/fedora.qcow2
      - VM_VNC_DISPLAY=:1
      - VM_SSH_PORT=2222

    # Restart policy
    restart: unless-stopped

    # Optional: Resource limits for the container itself
    # (separate from VM resources)
    # mem_limit: 6g
    # cpus: 6

volumes:
  skynet-vm-data:
    driver: local

# ============================================================================
# Usage:
# ============================================================================
#
# First time setup:
#   1. docker-compose build
#   2. docker-compose up -d
#   3. docker exec -it skynet-vm /vm/vm_setup/create_disk.sh /vm/fedora.qcow2 50G
#   4. Download Fedora ISO and mount it
#   5. docker-compose down
#   6. docker-compose run --rm -v /path/to/fedora.iso:/vm/fedora.iso:ro skynet-vm /usr/local/bin/launch_vm.sh install
#   7. Connect via VNC and complete installation
#   8. docker-compose up -d (normal operation)
#
# Daily usage:
#   Start:  docker-compose up -d
#   Stop:   docker-compose down
#   Logs:   docker-compose logs -f
#   Shell:  docker exec -it skynet-vm bash
#
# Connect:
#   VNC:    vncviewer localhost:5901
#   SSH:    ssh -p 2222 aiuser@localhost
#
# ============================================================================
