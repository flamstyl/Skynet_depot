# ============================================================================
# MCP KALI LINUX - Docker Compose Configuration
# ============================================================================
# Environnement isol√© Kali Linux pour IA de cybers√©curit√©
# R√©seau bridge isol√© par d√©faut
# Ports expos√©s uniquement en local (127.0.0.1)
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # SERVICE PRINCIPAL : Kali MCP
  # ==========================================================================
  kali_mcp:
    # Nom du conteneur
    container_name: mcp_kali

    # Construction depuis le Dockerfile local
    build:
      context: .
      dockerfile: Dockerfile

    # Image produite
    image: mcp_kali:latest

    # Garder stdin ouvert et allouer un pseudo-TTY (pour docker exec)
    stdin_open: true
    tty: true

    # Hostname du conteneur
    hostname: kali-mcp

    # ==========================================================================
    # VOLUMES PERSISTANTS
    # ==========================================================================
    volumes:
      # Logs de sessions (persistants entre red√©marrages)
      - ./logs:/logs

      # Contexte IA : missions, rapports, configs
      - ./ai_context:/ai_context

      # Workspace utilisateur (optionnel, pour projets persistants)
      - kali_workspace:/home/ia/workspace

      # Partage de fichiers avec l'h√¥te (optionnel, d√©commenter si besoin)
      # - ./shared:/home/ia/shared

    # ==========================================================================
    # R√âSEAU ISOL√â
    # ==========================================================================
    networks:
      - kali_net

    # ==========================================================================
    # EXPOSITION DES PORTS (LOCAL UNIQUEMENT)
    # ==========================================================================
    # ‚ö†Ô∏è S√âCURIT√â : Tous les ports sont bind√©s sur 127.0.0.1 uniquement
    # ‚ö†Ô∏è Pas d'exposition directe sur 0.0.0.0 (Internet)
    ports:
      # SSH (optionnel - d√©commenter si n√©cessaire)
      # Port h√¥te 2222 -> port conteneur 22
      # - "127.0.0.1:2222:22"

      # TTYD (terminal web pour IA)
      # Port h√¥te 7681 -> port conteneur 7681
      - "127.0.0.1:7681:7681"

      # Ports suppl√©mentaires pour services custom (d√©commenter si besoin)
      # - "127.0.0.1:8080:8080"  # HTTP custom
      # - "127.0.0.1:5000:5000"  # API Flask/FastAPI

    # ==========================================================================
    # VARIABLES D'ENVIRONNEMENT
    # ==========================================================================
    environment:
      # Timezone
      - TZ=Europe/Paris

      # Configuration MCP
      - MCP_MODE=full
      - MCP_LOG_LEVEL=INFO

      # D√©sactiver les prompts interactifs
      - DEBIAN_FRONTEND=noninteractive

      # Configuration utilisateur
      - USER=ia
      - HOME=/home/ia

    # ==========================================================================
    # CAPABILITIES & S√âCURIT√â
    # ==========================================================================
    # ‚ö†Ô∏è OPTION 1 (RECOMMAND√âE) : Capabilities limit√©es
    # Uniquement les capacit√©s n√©cessaires pour le r√©seau et les paquets
    cap_add:
      - NET_ADMIN      # Pour manipulation r√©seau (tcpdump, scapy, etc.)
      - NET_RAW        # Pour capture de paquets raw
      # - SYS_PTRACE   # D√©commenter si besoin de d√©buggage avec strace/gdb

    # Capabilities √† retirer pour s√©curit√© renforc√©e (optionnel)
    cap_drop:
      - ALL

    # Puis rajouter uniquement celles n√©cessaires avec cap_add ci-dessus

    # ‚ö†Ô∏è OPTION 2 (NON RECOMMAND√âE) : Mode privileged
    # ‚ö†Ô∏è Active TOUS les privil√®ges du host dans le conteneur
    # ‚ö†Ô∏è √Ä utiliser UNIQUEMENT si absolument n√©cessaire (docker-in-docker, etc.)
    # ‚ö†Ô∏è RISQUE DE S√âCURIT√â MAJEUR - Conteneur peut compromettre l'h√¥te
    # privileged: true

    # Options de s√©curit√© suppl√©mentaires
    security_opt:
      # Profil AppArmor personnalis√© (optionnel)
      # - apparmor:unconfined  # ‚ö†Ô∏è D√©conseill√© en production

      # Profil seccomp (optionnel, pour restrictions syscalls)
      # - seccomp:unconfined   # ‚ö†Ô∏è D√©conseill√© en production

      # Pas de nouveau privil√®ges
      - no-new-privileges:true

    # ==========================================================================
    # POLITIQUES DE RED√âMARRAGE
    # ==========================================================================
    # unless-stopped : red√©marre toujours sauf si arr√™t manuel
    restart: unless-stopped

    # Alternatives :
    # restart: "no"          # Jamais red√©marrer
    # restart: always        # Toujours red√©marrer
    # restart: on-failure    # Red√©marrer uniquement si erreur

    # ==========================================================================
    # RESSOURCES LIMIT√âES (optionnel mais recommand√©)
    # ==========================================================================
    # Limite l'utilisation CPU et m√©moire pour √©viter saturation h√¥te
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2.0'      # Max 2 CPU cores
    #       memory: 4G       # Max 4 GB RAM
    #     reservations:
    #       cpus: '0.5'      # Min 0.5 CPU
    #       memory: 1G       # Min 1 GB RAM

    # ==========================================================================
    # HEALTHCHECK
    # ==========================================================================
    # V√©rifie que le conteneur est sain (ttyd actif)
    healthcheck:
      test: ["CMD-SHELL", "pidof ttyd || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # ==========================================================================
    # D√âPENDANCES (si plusieurs services)
    # ==========================================================================
    # depends_on:
    #   - postgres
    #   - redis

# ============================================================================
# R√âSEAUX
# ============================================================================
networks:
  kali_net:
    driver: bridge

    # Configuration r√©seau personnalis√©e (optionnel)
    ipam:
      driver: default
      config:
        # Sous-r√©seau isol√© pour le lab
        - subnet: 172.28.0.0/16
          gateway: 172.28.0.1

    # Options du driver
    driver_opts:
      # Isolation inter-conteneurs (si plusieurs conteneurs)
      com.docker.network.bridge.enable_icc: "true"

      # Pas de connexion avec l'h√¥te par d√©faut (s√©curit√©)
      com.docker.network.bridge.enable_ip_masquerade: "true"

    # Labels pour organisation
    labels:
      - "com.mcp.network=kali_security_lab"
      - "com.mcp.environment=isolated"

# ============================================================================
# VOLUMES NOMM√âS
# ============================================================================
volumes:
  # Workspace persistant pour l'utilisateur IA
  kali_workspace:
    driver: local
    labels:
      - "com.mcp.volume=workspace"
      - "com.mcp.user=ia"

# ============================================================================
# NOTES D'UTILISATION
# ============================================================================
#
# BUILD :
#   docker compose build
#
# LANCEMENT :
#   docker compose up -d
#
# ARR√äT :
#   docker compose down
#
# LOGS :
#   docker compose logs -f kali_mcp
#
# SHELL INTERACTIF :
#   docker compose exec kali_mcp bash
#   # ou
#   docker exec -it mcp_kali bash
#
# TERMINAL WEB :
#   http://127.0.0.1:7681
#
# NETTOYAGE COMPLET (‚ö†Ô∏è supprime volumes) :
#   docker compose down -v
#
# ============================================================================
# S√âCURIT√â ET AVERTISSEMENTS
# ============================================================================
#
# ‚úÖ CONFIGURATION ACTUELLE :
#   - R√©seau bridge isol√© (172.28.0.0/16)
#   - Ports expos√©s uniquement sur localhost (127.0.0.1)
#   - Capabilities limit√©es (NET_ADMIN, NET_RAW uniquement)
#   - Pas de mode privileged
#
# ‚ö†Ô∏è  √Ä NE JAMAIS FAIRE EN PRODUCTION :
#   - Exposer les ports sur 0.0.0.0 (accessible depuis Internet)
#   - Activer privileged: true sans raison valable
#   - D√©sactiver les profils de s√©curit√© (AppArmor, seccomp)
#   - Lancer sur un serveur public sans VPN/Firewall
#
# üéØ USAGE PR√âVU :
#   - Environnement de test local
#   - CTF et challenges de s√©curit√©
#   - Pentest autoris√© sur infrastructure isol√©e
#   - Apprentissage et recherche en cybers√©curit√©
#
# ‚öñÔ∏è  CADRE L√âGAL :
#   - Usage strictement dans un cadre autoris√©
#   - Pentest uniquement avec accord √©crit du propri√©taire
#   - Respect des lois locales sur la cybers√©curit√©
#
# ============================================================================
