<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Browser - Skynet Memory Visualizer</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üìÇ Document Browser</h1>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="tree_view.html" class="nav-link active">Documents</a>
            <a href="editor.html" class="nav-link">Editor</a>
            <a href="compare.html" class="nav-link">Compare</a>
        </nav>

        <!-- Main Content -->
        <main class="browser-main">
            <!-- Toolbar -->
            <div class="toolbar">
                <div class="toolbar-left">
                    <button class="btn-icon" onclick="refreshTree()" title="Refresh">üîÑ</button>
                    <button class="btn-icon" onclick="expandAll()" title="Expand All">üìÇ</button>
                    <button class="btn-icon" onclick="collapseAll()" title="Collapse All">üìÅ</button>
                </div>
                <div class="toolbar-center">
                    <input type="text" id="filter-input" placeholder="Filter files...">
                </div>
                <div class="toolbar-right">
                    <select id="sort-select">
                        <option value="name">Sort by Name</option>
                        <option value="modified">Sort by Modified</option>
                        <option value="size">Sort by Size</option>
                        <option value="type">Sort by Type</option>
                    </select>
                </div>
            </div>

            <!-- Tree View Panel -->
            <div class="tree-panel">
                <div id="file-tree" class="file-tree">
                    <div class="tree-loading">Loading documents...</div>
                </div>
            </div>

            <!-- File Info Sidebar -->
            <aside class="file-info-sidebar">
                <div id="file-info" class="file-info">
                    <p class="info-placeholder">Select a file to view details</p>
                </div>
            </aside>
        </main>

        <!-- Context Menu -->
        <div id="context-menu" class="context-menu" style="display: none;">
            <div class="menu-item" onclick="contextAction('open')">üìÑ Open</div>
            <div class="menu-item" onclick="contextAction('open-new')">üóî Open in New Window</div>
            <div class="menu-separator"></div>
            <div class="menu-item" onclick="contextAction('rename')">‚úèÔ∏è Rename</div>
            <div class="menu-item" onclick="contextAction('delete')">üóëÔ∏è Delete</div>
            <div class="menu-separator"></div>
            <div class="menu-item" onclick="contextAction('copy-path')">üìã Copy Path</div>
            <div class="menu-item" onclick="contextAction('show-versions')">üïí Show Versions</div>
        </div>
    </div>

    <script src="js/api_bridge.js"></script>
    <script src="js/tree_view.js"></script>

    <script>
        let currentFile = null;
        let fileTree = null;

        // Initialize
        async function initBrowser() {
            try {
                fileTree = await api.getFileTree();
                renderTree(fileTree);
            } catch (error) {
                console.error('Failed to load file tree:', error);
                showError('Failed to load documents');
            }
        }

        function renderTree(tree) {
            const container = document.getElementById('file-tree');
            container.innerHTML = '';

            if (!tree || tree.length === 0) {
                container.innerHTML = '<p class="no-data">No documents found</p>';
                return;
            }

            const rootUl = document.createElement('ul');
            rootUl.className = 'tree-root';

            tree.forEach(node => {
                const li = createTreeNode(node);
                rootUl.appendChild(li);
            });

            container.appendChild(rootUl);
        }

        function createTreeNode(node) {
            const li = document.createElement('li');
            li.className = 'tree-node';
            li.dataset.path = node.path;
            li.dataset.type = node.type;

            const header = document.createElement('div');
            header.className = 'tree-node-header';

            // Expand/collapse icon for folders
            if (node.type === 'directory') {
                const toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                toggle.textContent = '‚ñ∂';
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    toggleNode(li);
                };
                header.appendChild(toggle);
            } else {
                const spacer = document.createElement('span');
                spacer.className = 'tree-spacer';
                header.appendChild(spacer);
            }

            // Icon
            const icon = document.createElement('span');
            icon.className = 'tree-icon';
            icon.textContent = getFileIcon(node);
            header.appendChild(icon);

            // Name
            const name = document.createElement('span');
            name.className = 'tree-name';
            name.textContent = node.name;
            header.appendChild(name);

            // Size (for files)
            if (node.type === 'file' && node.size) {
                const size = document.createElement('span');
                size.className = 'tree-size';
                size.textContent = formatBytes(node.size);
                header.appendChild(size);
            }

            header.onclick = () => selectNode(node, li);
            header.oncontextmenu = (e) => showContextMenu(e, node);

            li.appendChild(header);

            // Children (for directories)
            if (node.children && node.children.length > 0) {
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'tree-children';
                childrenUl.style.display = 'none';

                node.children.forEach(child => {
                    const childLi = createTreeNode(child);
                    childrenUl.appendChild(childLi);
                });

                li.appendChild(childrenUl);
            }

            return li;
        }

        function getFileIcon(node) {
            if (node.type === 'directory') return 'üìÅ';
            if (node.name.endsWith('.md')) return 'üìù';
            if (node.name.endsWith('.json')) return 'üîß';
            if (node.name.endsWith('.txt')) return 'üìÑ';
            return 'üìÑ';
        }

        function toggleNode(li) {
            const toggle = li.querySelector('.tree-toggle');
            const children = li.querySelector('.tree-children');

            if (children) {
                const isExpanded = children.style.display !== 'none';
                children.style.display = isExpanded ? 'none' : 'block';
                toggle.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
                li.classList.toggle('expanded', !isExpanded);
            }
        }

        function selectNode(node, li) {
            // Remove previous selection
            document.querySelectorAll('.tree-node-header').forEach(el => {
                el.classList.remove('selected');
            });

            // Add selection
            li.querySelector('.tree-node-header').classList.add('selected');

            currentFile = node;
            showFileInfo(node);

            // If it's a file, double-click opens it
            if (node.type === 'file') {
                li.querySelector('.tree-node-header').ondblclick = () => openFile(node);
            }
        }

        function showFileInfo(node) {
            const infoPanel = document.getElementById('file-info');

            if (node.type === 'directory') {
                infoPanel.innerHTML = `
                    <h3>üìÅ ${node.name}</h3>
                    <div class="info-section">
                        <p><strong>Type:</strong> Directory</p>
                        <p><strong>Path:</strong> ${node.path}</p>
                        <p><strong>Items:</strong> ${node.children ? node.children.length : 0}</p>
                    </div>
                `;
            } else {
                infoPanel.innerHTML = `
                    <h3>${getFileIcon(node)} ${node.name}</h3>
                    <div class="info-section">
                        <p><strong>Type:</strong> ${node.name.split('.').pop().toUpperCase()}</p>
                        <p><strong>Size:</strong> ${formatBytes(node.size || 0)}</p>
                        <p><strong>Path:</strong> ${node.path}</p>
                        ${node.modified ? `<p><strong>Modified:</strong> ${new Date(node.modified).toLocaleString()}</p>` : ''}
                    </div>
                    <div class="info-actions">
                        <button class="btn-primary" onclick="openFile(currentFile)">üìÑ Open</button>
                        <button class="btn-secondary" onclick="showVersions(currentFile)">üïí Versions</button>
                    </div>
                    <div class="info-section">
                        <h4>Tags</h4>
                        <div id="file-tags" class="tag-list">
                            <span class="tag-loading">Loading tags...</span>
                        </div>
                    </div>
                    <div class="info-section">
                        <h4>Preview</h4>
                        <div id="file-preview" class="file-preview">
                            <span class="preview-loading">Loading preview...</span>
                        </div>
                    </div>
                `;

                // Load tags and preview
                loadFileTags(node.path);
                loadFilePreview(node.path);
            }
        }

        async function loadFileTags(path) {
            try {
                const tags = await api.getTags(path);
                const container = document.getElementById('file-tags');
                if (tags && tags.length > 0) {
                    container.innerHTML = tags.map(tag =>
                        `<span class="tag">${tag}</span>`
                    ).join('');
                } else {
                    container.innerHTML = '<span class="no-tags">No tags</span>';
                }
            } catch (error) {
                document.getElementById('file-tags').innerHTML = '<span class="error">Failed to load tags</span>';
            }
        }

        async function loadFilePreview(path) {
            try {
                const preview = await api.getFilePreview(path, 5); // First 5 lines
                const container = document.getElementById('file-preview');
                container.innerHTML = `<pre>${escapeHtml(preview)}</pre>`;
            } catch (error) {
                document.getElementById('file-preview').innerHTML = '<span class="error">Failed to load preview</span>';
            }
        }

        function openFile(node) {
            if (node.type === 'file') {
                window.location.href = `editor.html?path=${encodeURIComponent(node.path)}`;
            }
        }

        function showVersions(node) {
            // TODO: Open versions view
            alert('Versions view coming soon');
        }

        function showContextMenu(e, node) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = e.pageX + 'px';
            menu.style.top = e.pageY + 'px';
            menu.dataset.path = node.path;
            menu.dataset.type = node.type;
        }

        function contextAction(action) {
            const menu = document.getElementById('context-menu');
            const path = menu.dataset.path;
            menu.style.display = 'none';

            switch (action) {
                case 'open':
                    window.location.href = `editor.html?path=${encodeURIComponent(path)}`;
                    break;
                case 'rename':
                    // TODO: Implement rename
                    alert('Rename functionality coming soon');
                    break;
                case 'delete':
                    if (confirm('Are you sure you want to delete this file?')) {
                        deleteFile(path);
                    }
                    break;
                case 'copy-path':
                    navigator.clipboard.writeText(path);
                    break;
                case 'show-versions':
                    alert('Versions view coming soon');
                    break;
            }
        }

        async function deleteFile(path) {
            try {
                await api.deleteFile(path);
                showSuccess('File deleted');
                refreshTree();
            } catch (error) {
                showError('Failed to delete file: ' + error.message);
            }
        }

        function refreshTree() {
            initBrowser();
        }

        function expandAll() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.tree-toggle').forEach(el => {
                el.textContent = '‚ñº';
            });
        }

        function collapseAll() {
            document.querySelectorAll('.tree-children').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.tree-toggle').forEach(el => {
                el.textContent = '‚ñ∂';
            });
        }

        // Filter functionality
        document.getElementById('filter-input')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            filterTree(query);
        });

        function filterTree(query) {
            document.querySelectorAll('.tree-node').forEach(node => {
                const name = node.querySelector('.tree-name').textContent.toLowerCase();
                const match = name.includes(query);
                node.style.display = match || query === '' ? '' : 'none';
            });
        }

        // Close context menu on click outside
        document.addEventListener('click', () => {
            document.getElementById('context-menu').style.display = 'none';
        });

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(msg) {
            alert(msg);
        }

        function showError(msg) {
            alert(msg);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initBrowser);
    </script>
</body>
</html>
