<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - Skynet Memory Visualizer</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container editor-container">
        <!-- Header -->
        <header class="header">
            <h1>üìù Document Editor</h1>
            <div class="header-actions">
                <button id="save-btn" class="btn-primary" onclick="saveDocument()">üíæ Save</button>
                <button class="btn-secondary" onclick="closeEditor()">‚úñ Close</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <a href="index.html" class="nav-link">Dashboard</a>
            <a href="tree_view.html" class="nav-link">Documents</a>
            <a href="editor.html" class="nav-link active">Editor</a>
            <a href="compare.html" class="nav-link">Compare</a>
        </nav>

        <!-- Main Editor Layout -->
        <main class="editor-main">
            <!-- Editor Area -->
            <div class="editor-area">
                <!-- Toolbar -->
                <div class="editor-toolbar">
                    <div class="toolbar-group">
                        <button class="tool-btn" onclick="formatBold()" title="Bold"><strong>B</strong></button>
                        <button class="tool-btn" onclick="formatItalic()" title="Italic"><em>I</em></button>
                        <button class="tool-btn" onclick="formatCode()" title="Code">&lt;/&gt;</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="tool-btn" onclick="insertHeading()" title="Heading">#</button>
                        <button class="tool-btn" onclick="insertList()" title="List">‚â°</button>
                        <button class="tool-btn" onclick="insertLink()" title="Link">üîó</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="tool-btn" onclick="togglePreview()" title="Toggle Preview">üëÅ</button>
                        <button class="tool-btn" onclick="toggleSplit()" title="Split View">‚öè</button>
                    </div>
                </div>

                <!-- File Info Bar -->
                <div class="file-info-bar">
                    <span id="file-path" class="file-path">No file loaded</span>
                    <span id="file-stats" class="file-stats"></span>
                    <span id="save-status" class="save-status"></span>
                </div>

                <!-- Editor/Preview Split -->
                <div class="editor-split">
                    <div id="editor-pane" class="editor-pane">
                        <textarea id="editor" class="code-editor" placeholder="Start typing..."></textarea>
                    </div>
                    <div id="preview-pane" class="preview-pane" style="display: none;">
                        <div id="preview" class="markdown-preview"></div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="editor-sidebar">
                <!-- Tabs -->
                <div class="sidebar-tabs">
                    <button class="tab-btn active" data-tab="tags">üè∑Ô∏è Tags</button>
                    <button class="tab-btn" data-tab="ai">ü§ñ AI</button>
                    <button class="tab-btn" data-tab="history">üïí History</button>
                    <button class="tab-btn" data-tab="metadata">üìä Metadata</button>
                </div>

                <!-- Tab: Tags -->
                <div class="tab-content active" data-tab="tags">
                    <h3>Tags</h3>
                    <div id="tags-container" class="tags-container">
                        <div class="tags-list" id="tags-list">
                            <span class="tag-loading">Loading tags...</span>
                        </div>
                        <div class="add-tag-form">
                            <input type="text" id="new-tag-input" placeholder="Add tag...">
                            <button onclick="addTag()">+</button>
                        </div>
                    </div>
                    <button class="btn-suggest" onclick="suggestTags()">‚ú® AI Suggest Tags</button>
                </div>

                <!-- Tab: AI Actions -->
                <div class="tab-content" data-tab="ai">
                    <h3>AI Actions</h3>
                    <div class="ai-actions">
                        <button class="ai-action-btn" onclick="aiRegenerate()">
                            <span class="ai-icon">‚ú®</span>
                            Regenerate Document
                            <small>Improve structure & clarity</small>
                        </button>
                        <button class="ai-action-btn" onclick="aiSummarize()">
                            <span class="ai-icon">üìã</span>
                            Generate Summary
                            <small>Create concise summary</small>
                        </button>
                        <button class="ai-action-btn" onclick="aiExtractMetadata()">
                            <span class="ai-icon">üîç</span>
                            Extract Metadata
                            <small>Auto-detect title, tags, etc.</small>
                        </button>
                        <button class="ai-action-btn" onclick="aiImprove()">
                            <span class="ai-icon">üöÄ</span>
                            Improve Writing
                            <small>Enhance readability</small>
                        </button>
                    </div>
                    <div id="ai-result" class="ai-result" style="display: none;">
                        <h4>AI Result</h4>
                        <div id="ai-result-content"></div>
                        <div class="ai-result-actions">
                            <button onclick="acceptAIResult()">‚úì Accept</button>
                            <button onclick="compareAIResult()">‚öè Compare</button>
                            <button onclick="rejectAIResult()">‚úó Reject</button>
                        </div>
                    </div>
                </div>

                <!-- Tab: Version History -->
                <div class="tab-content" data-tab="history">
                    <h3>Version History</h3>
                    <div id="history-list" class="history-list">
                        <div class="history-loading">Loading history...</div>
                    </div>
                </div>

                <!-- Tab: Metadata -->
                <div class="tab-content" data-tab="metadata">
                    <h3>Metadata</h3>
                    <div id="metadata-container" class="metadata-container">
                        <div class="metadata-item">
                            <label>Title:</label>
                            <input type="text" id="meta-title" placeholder="Document title">
                        </div>
                        <div class="metadata-item">
                            <label>Description:</label>
                            <textarea id="meta-description" placeholder="Brief description"></textarea>
                        </div>
                        <div class="metadata-item">
                            <label>Category:</label>
                            <select id="meta-category">
                                <option value="">Select category</option>
                                <option value="architecture">Architecture</option>
                                <option value="implementation">Implementation</option>
                                <option value="documentation">Documentation</option>
                                <option value="planning">Planning</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="metadata-item">
                            <label>Created:</label>
                            <span id="meta-created">-</span>
                        </div>
                        <div class="metadata-item">
                            <label>Modified:</label>
                            <span id="meta-modified">-</span>
                        </div>
                        <div class="metadata-item">
                            <label>Size:</label>
                            <span id="meta-size">-</span>
                        </div>
                        <button class="btn-secondary" onclick="saveMetadata()">Save Metadata</button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- AI Processing Modal -->
    <div id="ai-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ü§ñ AI Processing</h3>
            </div>
            <div class="modal-body">
                <div class="ai-progress">
                    <div class="spinner"></div>
                    <p id="ai-status">Processing...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/api_bridge.js"></script>
    <script src="js/editor.js"></script>

    <script>
        let currentDocument = null;
        let currentPath = null;
        let isModified = false;
        let aiResultCache = null;

        // Initialize editor
        async function initEditor() {
            // Get file path from URL
            const params = new URLSearchParams(window.location.search);
            currentPath = params.get('path');

            if (!currentPath) {
                document.getElementById('file-path').textContent = 'No file selected';
                return;
            }

            try {
                // Load document
                currentDocument = await api.loadDocument(currentPath);
                document.getElementById('editor').value = currentDocument.content || '';
                document.getElementById('file-path').textContent = currentPath;

                // Load metadata
                loadMetadata(currentDocument.metadata);

                // Load tags
                loadTags(currentDocument.tags);

                // Load history
                loadHistory(currentPath);

                // Update stats
                updateStats();

                // Auto-save setup
                setupAutoSave();
            } catch (error) {
                console.error('Failed to load document:', error);
                alert('Failed to load document: ' + error.message);
            }
        }

        function loadMetadata(metadata) {
            if (!metadata) return;

            document.getElementById('meta-title').value = metadata.title || '';
            document.getElementById('meta-description').value = metadata.description || '';
            document.getElementById('meta-category').value = metadata.category || '';
            document.getElementById('meta-created').textContent = metadata.created ?
                new Date(metadata.created).toLocaleString() : '-';
            document.getElementById('meta-modified').textContent = metadata.modified ?
                new Date(metadata.modified).toLocaleString() : '-';
            document.getElementById('meta-size').textContent = metadata.size ?
                formatBytes(metadata.size) : '-';
        }

        function loadTags(tags) {
            const container = document.getElementById('tags-list');
            if (!tags || tags.length === 0) {
                container.innerHTML = '<span class="no-tags">No tags</span>';
                return;
            }

            container.innerHTML = tags.map(tag => `
                <span class="tag">
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${tag}')">√ó</button>
                </span>
            `).join('');
        }

        async function loadHistory(path) {
            try {
                const history = await api.getHistory(path);
                const container = document.getElementById('history-list');

                if (!history || history.length === 0) {
                    container.innerHTML = '<p class="no-data">No version history</p>';
                    return;
                }

                container.innerHTML = history.map(version => `
                    <div class="history-item" onclick="viewVersion('${version.version_id}')">
                        <div class="history-time">${formatTimeAgo(version.timestamp)}</div>
                        <div class="history-desc">${version.summary || 'No description'}</div>
                        <div class="history-stats">
                            <span class="stat-add">+${version.diff_stats?.lines_added || 0}</span>
                            <span class="stat-remove">-${version.diff_stats?.lines_removed || 0}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        async function saveDocument() {
            try {
                const content = document.getElementById('editor').value;
                const result = await api.saveDocument(currentPath, content);

                document.getElementById('save-status').textContent = '‚úì Saved';
                setTimeout(() => {
                    document.getElementById('save-status').textContent = '';
                }, 2000);

                isModified = false;
                loadHistory(currentPath);
            } catch (error) {
                alert('Failed to save: ' + error.message);
            }
        }

        async function saveMetadata() {
            try {
                const metadata = {
                    title: document.getElementById('meta-title').value,
                    description: document.getElementById('meta-description').value,
                    category: document.getElementById('meta-category').value
                };

                await api.saveMetadata(currentPath, metadata);
                alert('Metadata saved');
            } catch (error) {
                alert('Failed to save metadata: ' + error.message);
            }
        }

        async function addTag() {
            const input = document.getElementById('new-tag-input');
            const tag = input.value.trim();

            if (!tag) return;

            try {
                await api.addTag(currentPath, tag);
                input.value = '';

                // Reload tags
                const doc = await api.loadDocument(currentPath);
                loadTags(doc.tags);
            } catch (error) {
                alert('Failed to add tag: ' + error.message);
            }
        }

        async function removeTag(tag) {
            try {
                await api.removeTag(currentPath, tag);

                // Reload tags
                const doc = await api.loadDocument(currentPath);
                loadTags(doc.tags);
            } catch (error) {
                alert('Failed to remove tag: ' + error.message);
            }
        }

        async function suggestTags() {
            try {
                showAIModal('Analyzing document for tags...');
                const content = document.getElementById('editor').value;
                const tags = await api.suggestTags(content);
                hideAIModal();

                if (tags && tags.length > 0) {
                    if (confirm(`Add these tags?\n${tags.join(', ')}`)) {
                        for (const tag of tags) {
                            await api.addTag(currentPath, tag);
                        }
                        const doc = await api.loadDocument(currentPath);
                        loadTags(doc.tags);
                    }
                }
            } catch (error) {
                hideAIModal();
                alert('Failed to suggest tags: ' + error.message);
            }
        }

        async function aiRegenerate() {
            if (!confirm('Regenerate this document with AI? This will create a new version.')) return;

            try {
                showAIModal('Regenerating document...');
                const content = document.getElementById('editor').value;
                const result = await api.aiRegenerate(content);
                hideAIModal();

                aiResultCache = result;
                showAIResult(result);
            } catch (error) {
                hideAIModal();
                alert('AI regeneration failed: ' + error.message);
            }
        }

        async function aiSummarize() {
            try {
                showAIModal('Generating summary...');
                const content = document.getElementById('editor').value;
                const summary = await api.aiSummarize(content);
                hideAIModal();

                alert('Summary:\n\n' + summary);
            } catch (error) {
                hideAIModal();
                alert('Failed to summarize: ' + error.message);
            }
        }

        async function aiExtractMetadata() {
            try {
                showAIModal('Extracting metadata...');
                const content = document.getElementById('editor').value;
                const metadata = await api.aiExtractMetadata(content);
                hideAIModal();

                if (metadata) {
                    document.getElementById('meta-title').value = metadata.title || '';
                    document.getElementById('meta-description').value = metadata.description || '';
                    if (metadata.tags && metadata.tags.length > 0) {
                        if (confirm(`Also add these tags?\n${metadata.tags.join(', ')}`)) {
                            for (const tag of metadata.tags) {
                                await api.addTag(currentPath, tag);
                            }
                            const doc = await api.loadDocument(currentPath);
                            loadTags(doc.tags);
                        }
                    }
                }
            } catch (error) {
                hideAIModal();
                alert('Failed to extract metadata: ' + error.message);
            }
        }

        function showAIResult(result) {
            const resultDiv = document.getElementById('ai-result');
            const contentDiv = document.getElementById('ai-result-content');
            contentDiv.innerHTML = `<pre>${escapeHtml(result)}</pre>`;
            resultDiv.style.display = 'block';
        }

        function acceptAIResult() {
            if (aiResultCache) {
                document.getElementById('editor').value = aiResultCache;
                saveDocument();
            }
            rejectAIResult();
        }

        function compareAIResult() {
            // TODO: Open compare view
            alert('Compare view coming soon');
        }

        function rejectAIResult() {
            document.getElementById('ai-result').style.display = 'none';
            aiResultCache = null;
        }

        function showAIModal(message) {
            document.getElementById('ai-status').textContent = message;
            document.getElementById('ai-modal').style.display = 'flex';
        }

        function hideAIModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        function togglePreview() {
            const preview = document.getElementById('preview-pane');
            const isVisible = preview.style.display !== 'none';
            preview.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                updatePreview();
            }
        }

        function toggleSplit() {
            // TODO: Implement split view
            togglePreview();
        }

        function updatePreview() {
            // TODO: Use marked.js or similar for markdown rendering
            const content = document.getElementById('editor').value;
            document.getElementById('preview').innerHTML = `<pre>${escapeHtml(content)}</pre>`;
        }

        function updateStats() {
            const content = document.getElementById('editor').value;
            const lines = content.split('\n').length;
            const chars = content.length;
            const words = content.trim().split(/\s+/).length;

            document.getElementById('file-stats').textContent =
                `${lines} lines, ${words} words, ${chars} chars`;
        }

        function setupAutoSave() {
            const editor = document.getElementById('editor');
            let timeout;

            editor.addEventListener('input', () => {
                isModified = true;
                updateStats();
                updatePreview();

                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    document.getElementById('save-status').textContent = 'Auto-saving...';
                    saveDocument();
                }, 3000);
            });
        }

        function closeEditor() {
            if (isModified && !confirm('You have unsaved changes. Close anyway?')) {
                return;
            }
            window.location.href = 'tree_view.html';
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                btn.classList.add('active');
                document.querySelector(`.tab-content[data-tab="${tab}"]`).classList.add('active');
            });
        });

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diff = Math.floor((now - past) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return `${Math.floor(diff / 86400)}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', initEditor);

        // Warn before leaving if modified
        window.addEventListener('beforeunload', (e) => {
            if (isModified) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
